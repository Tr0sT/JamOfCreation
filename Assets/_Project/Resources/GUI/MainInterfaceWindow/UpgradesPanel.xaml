<UserControl xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:i="http://schemas.microsoft.com/expression/2010/interactivity"
             xmlns:noesis="clr-namespace:NoesisGUIExtensions;assembly=Noesis.GUI.Extensions"
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:local="clr-namespace:NuclearBand.Game">
  <noesis:Xaml.Dependencies>
    <noesis:Dependency Source="Energy.png"/>
    <noesis:Dependency Source="Ideas.png"/>
    <noesis:Dependency Source="Code.png"/>
    <noesis:Dependency Source="Art.png"/>
  </noesis:Xaml.Dependencies>

  <UserControl.Resources>
    <local:EnumToBooleanConverter x:Key="EnumToBooleanConverter" />
    <local:EmojiRichTextConverter x:Key="EmojiRichTextConverter"/>
    <Style x:Key="BarContainer" TargetType="Border">
      <Setter Property="CornerRadius" Value="12"/>
      <Setter Property="Padding" Value="12"/>
      <Setter Property="Background" Value="#0F223B"/>
    </Style>

    <!-- Item -->
    <DataTemplate x:Key="UpgradeItemTemplate">
      <Border x:Name="UpgradeBorder" Padding="20" Margin="0,12,0,12" CornerRadius="10" Background="#0B1A2E">
        <Border.InputBindings>
          <MouseBinding Command="{Binding OnClick}" MouseAction="LeftClick"/>
        </Border.InputBindings>
        <Grid>
          <Grid.ColumnDefinitions>
            <ColumnDefinition Width="Auto"/>
            <ColumnDefinition Width="*"/>
            <ColumnDefinition Width="Auto"/>
          </Grid.ColumnDefinitions>

          <!-- Иконка/плейсхолдер -->
          <Border Width="120" Height="120" Background="#10283E" CornerRadius="10" Margin="0,0,24,0" />

          <!-- Текстовая часть -->
          <StackPanel Grid.Column="1" VerticalAlignment="Center">
            <TextBlock Text="{Binding Title}" FontSize="60" Foreground="#FFFFFFFF" FontWeight="Bold" TextWrapping="Wrap" MaxWidth="760"/>
            <TextBlock Text="{Binding Description}" FontSize="36" Foreground="#BFDFF6" TextTrimming="CharacterEllipsis" MaxWidth="760" Margin="0,8,0,0"/>
          </StackPanel>

          <!-- Стоимость -->
          <TextBlock Grid.Column="2" 
                     noesis:RichText.Text="{Binding Cost, Converter={StaticResource EmojiRichTextConverter}}"
                     VerticalAlignment="Center" FontSize="48" Foreground="#A0D9FF" FontWeight="SemiBold" />
        </Grid>
      </Border>
    </DataTemplate>

    <!-- Thumb без спрайтов -->
    <Style x:Key="WideScrollBarThumb" TargetType="Thumb">
      <Setter Property="MinHeight" Value="40"/>
      <Setter Property="MinWidth" Value="40"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="Thumb">
            <Border x:Name="bg" Background="#5C7890" CornerRadius="8" SnapsToDevicePixels="True"/>
            <ControlTemplate.Triggers>
              <Trigger Property="IsMouseOver" Value="True">
                <Setter TargetName="bg" Property="Background" Value="#7FB2D6"/>
              </Trigger>
              <Trigger Property="IsDragging" Value="True">
                <Setter TargetName="bg" Property="Background" Value="#9ED2FF"/>
              </Trigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

    <!-- Чистый шаблон ScrollBar с переключением команд по ориентации -->
    <Style x:Key="WideScrollBar" TargetType="ScrollBar">
      <Setter Property="Width" Value="22"/>
      <Setter Property="Background" Value="#113147"/>
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="ScrollBar">
            <Grid Background="{TemplateBinding Background}" SnapsToDevicePixels="True">
              <Track x:Name="PART_Track" Orientation="{TemplateBinding Orientation}" IsDirectionReversed="True" SnapsToDevicePixels="True">
                <Track.DecreaseRepeatButton>
                  <RepeatButton x:Name="PART_PageDec" Opacity="0" Focusable="False" Command="{x:Static ScrollBar.PageUpCommand}"/>
                </Track.DecreaseRepeatButton>
                <Track.IncreaseRepeatButton>
                  <RepeatButton x:Name="PART_PageInc" Opacity="0" Focusable="False" Command="{x:Static ScrollBar.PageDownCommand}"/>
                </Track.IncreaseRepeatButton>
                <Track.Thumb>
                  <Thumb Style="{StaticResource WideScrollBarThumb}"/>
                </Track.Thumb>
              </Track>
            </Grid>
            <ControlTemplate.Triggers>
              <!-- Горизонтальная ориентация: команды влево/вправо и меньшая высота -->
              <Trigger Property="Orientation" Value="Horizontal">
                <Setter Property="Height" Value="22"/>
                <Setter Property="Width" Value="Auto"/>
                <Setter TargetName="PART_PageDec" Property="RepeatButton.Command" Value="{x:Static ScrollBar.PageLeftCommand}"/>
                <Setter TargetName="PART_PageInc" Property="RepeatButton.Command" Value="{x:Static ScrollBar.PageRightCommand}"/>
                <Setter TargetName="PART_Track" Property="Track.IsDirectionReversed" Value="False"/>
              </Trigger>
              <!-- Отключено -->
              <Trigger Property="IsEnabled" Value="False">
                <Setter Property="Background" Value="#0D1E2D"/>
              </Trigger>
            </ControlTemplate.Triggers>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
      <Style.Triggers>
        <Trigger Property="Orientation" Value="Horizontal">
          <Setter Property="Height" Value="22"/>
          <Setter Property="Width" Value="Auto"/>
        </Trigger>
      </Style.Triggers>
    </Style>

    <!-- Явный шаблон ScrollViewer, чтобы применился наш ScrollBar -->
    <Style x:Key="PlainScrollViewer" TargetType="ScrollViewer">
      <Setter Property="Template">
        <Setter.Value>
          <ControlTemplate TargetType="ScrollViewer">
            <Grid>
              <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
              </Grid.ColumnDefinitions>
              <Grid.RowDefinitions>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
              </Grid.RowDefinitions>

              <!-- Контент -->
              <ScrollContentPresenter x:Name="PART_ScrollContentPresenter"
                                      Grid.Row="0" Grid.Column="0"
                                      CanContentScroll="{TemplateBinding CanContentScroll}"
                                      Content="{TemplateBinding Content}"
                                      ContentTemplate="{TemplateBinding ContentTemplate}"
                                      Margin="{TemplateBinding Padding}"/>

              <!-- Вертикальная полоса -->
              <ScrollBar x:Name="PART_VerticalScrollBar"
                         Grid.Row="0" Grid.Column="1"
                         Style="{StaticResource WideScrollBar}"
                         Orientation="Vertical"
                         Minimum="0"
                         Maximum="{TemplateBinding ScrollableHeight}"
                         ViewportSize="{TemplateBinding ViewportHeight}"
                         Value="{TemplateBinding VerticalOffset}"
                         Visibility="{TemplateBinding ComputedVerticalScrollBarVisibility}"/>

              <!-- Горизонтальная полоса (если понадобится) -->
              <ScrollBar x:Name="PART_HorizontalScrollBar"
                         Grid.Row="1" Grid.Column="0"
                         Style="{StaticResource WideScrollBar}"
                         Orientation="Horizontal"
                         Minimum="0"
                         Maximum="{TemplateBinding ScrollableWidth}"
                         ViewportSize="{TemplateBinding ViewportWidth}"
                         Value="{TemplateBinding HorizontalOffset}"
                         Visibility="{TemplateBinding ComputedHorizontalScrollBarVisibility}"/>
            </Grid>
          </ControlTemplate>
        </Setter.Value>
      </Setter>
    </Style>

  </UserControl.Resources>

  <!-- Обёртка Viewbox для авто-скейлинга под reference 1080x2340 -->
  <Viewbox Stretch="Uniform">
    <Grid Width="1080" Margin="0" Background="Transparent">
      <StackPanel Margin="30">
        <TextBlock Text="Развитие:" FontSize="60" Foreground="#FFFFFFFF" Margin="0,0,0,24" FontWeight="Bold"/>

        <!-- Применяем явный стиль ScrollViewer -->
        <ScrollViewer Height="750"
                      VerticalScrollBarVisibility="Auto"
                      Style="{StaticResource PlainScrollViewer}">
          <ItemsControl ItemsSource="{Binding AvailableUpgrades}"
                        ItemTemplate="{StaticResource UpgradeItemTemplate}"/>
        </ScrollViewer>
      </StackPanel>
    </Grid>
  </Viewbox>
</UserControl>
